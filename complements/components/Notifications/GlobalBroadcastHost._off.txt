"use client";

import React, { useEffect, useMemo, useState } from "react";
import { useProvider } from "@/app/providers/FdvProvider";
import {
  DIV,
  H2,
  P,
  BUTTON,
  SPAN,
} from "@/complements/components/ui/wrappers";

// Debe alinear con NOTIFICATIONS_PANEL_SCHEMA
type NotificationConfig = {
  notificationId?: string;
  enabled?: boolean;
  title?: string;
  message?: string;
  description?: string;
  userInterfaceType?: "popup" | "badge" | "popupAndBadge";
  deliveryChannel?: "inApp" | "push" | "both";
  targetAudienceType?:
    | "allUsers"
    | "authenticated"
    | "byRole"
    | "bySegment"
    | "byUserId"
    | string;
  // dejamos el resto fuera por simplicidad; si luego quieres más campos, se agregan
};

type NotificationsProviderDoc = {
  notifications?: NotificationConfig[];
};

const LOCAL_KEY = "nixinx_seenGlobalNotifications_v1";

function loadSeenFromStorage(): string[] {
  if (typeof window === "undefined") return [];
  try {
    const raw = window.localStorage.getItem(LOCAL_KEY);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];
    return parsed.filter((x) => typeof x === "string");
  } catch {
    return [];
  }
}

function saveSeenToStorage(ids: string[]) {
  if (typeof window === "undefined") return;
  try {
    window.localStorage.setItem(LOCAL_KEY, JSON.stringify(ids));
  } catch {
    // no pasa nada si falla
  }
}

/**
 * Host global de promos:
 * - Lee Providers/Notifications (FDV).
 * - Muestra solo notificaciones:
 *    - enabled === true
 *    - targetAudienceType === "allUsers"
 *    - deliveryChannel ∈ { "inApp", "both", undefined }
 * - Usa localStorage para no volver a mostrar una vez cerrada.
 * - No usa uid ni userNotifications: funciona para anónimos.
 */
const GlobalBroadcastHost: React.FC = () => {
  const { value: notificationsDoc } =
    useProvider<NotificationsProviderDoc>("notifications");

  const [seenIds, setSeenIds] = useState<string[]>([]);

  // Cargar lista de notificaciones ya vistas en este dispositivo
  useEffect(() => {
    setSeenIds(loadSeenFromStorage());
  }, []);

  const activeList = useMemo(() => {
    const all = notificationsDoc?.notifications ?? [];

    return all
      .filter((n) => n && n.enabled)
      .filter((n) => n.targetAudienceType === "allUsers")
      .filter((n) => {
        const ch = n.deliveryChannel ?? "inApp";
        return ch === "inApp" || ch === "both";
      })
      .filter((n) => {
        const id = n.notificationId;
        if (!id) return false;
        return !seenIds.includes(id);
      });
  }, [notificationsDoc, seenIds]);

  const current = activeList[0];

  if (!current) return null;

  const handleClose = () => {
    const id = current.notificationId;
    if (!id) return;
    const next = Array.from(new Set([...seenIds, id]));
    setSeenIds(next);
    saveSeenToStorage(next);
  };

  const handlePrimaryClick = () => {
    const any = current as any;
    const url: string | undefined =
      any.clickAction || any.callToActionURL || undefined;

    if (url && typeof window !== "undefined") {
      window.location.href = url;
    }

    // Aunque navegue, marcamos como vista
    handleClose();
  };

  return (
    <DIV className="fixed bottom-4 right-4 z-40 max-w-sm w-[90vw] md:w-96 bg-black/90 border border-white/15 rounded-lg shadow-lg p-4 flex flex-col gap-3">
      <H2 className="text-sm font-semibold">
        {current.title || "Aviso"}
      </H2>

      <P className="text-xs opacity-80 whitespace-pre-line">
        {current.message || current.description || ""}
      </P>

      <DIV className="flex justify-end gap-2 mt-1">
        <BUTTON type="button" kind="button" onClick={handleClose}>
          Cerrar
        </BUTTON>
        <BUTTON
          type="button"
          kind="button"
          onClick={handlePrimaryClick}
        >
          Ver más
        </BUTTON>
      </DIV>

      <P className="text-[10px] opacity-50 mt-1">
        <SPAN>
          Esta promoción no volverá a mostrarse en este dispositivo.
        </SPAN>
      </P>
    </DIV>
  );
};

export default GlobalBroadcastHost;
